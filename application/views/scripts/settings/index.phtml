<?php
$i = 1;
$projectConfig = $this->config->getParam('project');
?>
<form action="<?php echo $this->baseUrl();?>/settings/index" method="post">
<h2><?php echo $this->lang->L_CONFIGURATION;?></h2>
<h4><?php echo $this->lang->L_INTERFACE_LANGUAGE;?>:</h4>
<p>
    <?php echo $this->lang->L_SELECT_LANGUAGE_OF_INTERFACE;?>:
    <select name="interfaceLanguage">
        <?php echo $this->selInterfaceLanguage;?>
    </select>
    <button type="submit" class="Formbutton"><?php echo $this->getIcon('save', '');?> <?php echo $this->lang->L_SAVE_SETTINGS;?></button>
</p>

<h4><?php echo $this->lang->L_ENTRIES_PER_PAGE;?>:</h4>
<p>
    <?php echo $this->lang->L_SELECT_HOW_MANY_ENTRIES_SHOULD_BE_SHOWN_PER_PAGE;?>:
    <select name="recordsPerPage">
        <?php echo $this->selRecordsPerPage;?>
    </select>
    <button type="submit" class="Formbutton"><?php echo $this->getIcon('save', '');?> <?php echo $this->lang->L_SAVE_SETTINGS;?></button>
</p>

<h4><?php echo $this->lang->L_YOU_ARE_ALLOWED_TO_EDIT_FOLLOWING_LANGUAGES;?>:</h4>
<table class="bdr small" summary="List of languages you are allowed to edit">
    <tr class="thead">
        <th>#</th>
        <th colspan="3"><?php echo $this->lang->L_LANGUAGES;?></th>
        <th><?php echo $this->lang->L_FALLBACK_LANGUAGE;?></th>
    </tr>
<?php
    foreach ($this->editLanguages as $lang)
    {
        $langId = $lang;
        $langName = $this->languages[$langId]['name'];
        $langLocale = $this->languages[$langId]['locale'];
    ?>
        <tr class="<?php echo $this->cycle(array('row-even', 'row-odd'))->next();?>">
            <td class="right"><?php echo $i;?>.</td>
            <td>
                <?php echo $this->printFlag($langId);?>
            </td>
            <td><?php echo $langLocale;?></td>
            <td><?php echo $langName;?></td>
            <td>
                <?php
                    if ($langId == $this->fallbackLanguageId) {
                        echo $this->getIcon('Ok', '', 16);
                    }
                ?>
                &nbsp;
            </td>
        </tr>
    <?php
        $i++;
    }
    ?>
</table>

<div class="spacer"></div>
<h4><?php echo $this->lang->L_SELECT_YOUR_REFERENCE_LANGUAGES;?>:</h4>
<p><?php echo $this->lang->L_REFERENCE_LANGUAGES_EXPLAIN;?></p>
<table class="bdr" summary="List of all languages you can select as a reference">
    <tr class="thead">
        <th>#</th>
        <th colspan="3"><?php echo $this->lang->L_REFERENCE_LANGUAGES;?></th>
        <th><?php echo $this->lang->L_STATUS;?></th>
    </tr>
    <?php
    $i = 1;
    /**
     * @var Zend_View_Helper_Cycle $cycle
     */
    $cycle = $this->cycle(array('row-even', 'row-odd'));
    $switchStatusTitle = 'title="'. $this->lang->L_CHANGE_STATUS . '"';
    foreach ($this->languages as $key => $language)
    {
        $id = 'lang_'.$language['id'];
        $langId = $language['id'];
        if ($langId == $this->fallbackLanguageId) {
            // fallback language cannot be deactivated - skip
            continue;
        }
        $langName = $this->languages[$langId]['name'];
        $langLocale = $this->languages[$langId]['locale'];
        ?>
        <tr class="<?php echo $cycle->next();?>">
            <td class="right"><?php echo $i;?>.</td>
            <td>
                <label for="img-<?php echo $language['id'];?>" class="switchUserReferenceLanguageLabel">
                    <?php echo $this->printFlag($key);?>
                </label>
            </td>
            <td>
                <label <?php echo $switchStatusTitle;?> for="img-<?php echo $language['id'];?>" class="switchUserReferenceLanguageLabel">
                    <?php echo $langLocale;?>
                </label>
            </td>
            <td>
                <label <?php echo $switchStatusTitle;?> for="img-<?php echo $language['id'];?>" class="switchUserReferenceLanguageLabel">
                    <?php echo $langName;?>
                </label>
            </td>
            <td>
                <div id="img-<?php echo $language['id'];?>" class="switchUserReferenceLanguage">
                    <?php
                        if (in_array($key, $this->refLanguagesSelected)) {
                            echo $this->getIcon('Ok', $this->lang->L_CHANGE_STATUS, 16);
                        } else {
                            echo $this->getIcon('NotOk', $this->lang->L_CHANGE_STATUS, 16);
                        }
                    ;?>
                </div>
            </td>
        </tr>
    <?php
        $i++;
    }
    ?>
</table>

<div class="spacer clear"></div>

<h4><?php echo $this->lang->L_CHANGE_YOUR_PASSWORD; ?></h4>
<table class="bdr" summary="Change the password of your user account.">
    <tr class="thead">
        <th colspan="2"><?php echo $this->lang->L_CHANGE_PASSWORD; ?></th>
    </tr>
    <tr class="row-even">
        <td><label for="oldPassword"><?php echo $this->lang->L_OLD_PASSWORD; ?> (*):</label></td>
        <td><input type="password" name="oldPassword" id="oldPassword" class="text"/></td>
    </tr>
    <tr class="row-odd">
        <td><label for="newPassword"><?php echo $this->lang->L_NEW_PASSWORD; ?> (*):</label></td>
        <td><input type="password" name="newPassword" id="newPassword" class="text"/></td>
    </tr>
    <tr class="row-even">
        <td><label for="newPasswordConfirm"><?php echo $this->lang->L_CONFIRM_PASSWORD; ?> (*):</label></td>
        <td><input type="password" name="newPasswordConfirm" id="newPasswordConfirm" class="text"/></td>
    </tr>
    <tr class="row-odd">
        <td colspan="2">
            <div class="confirm-password-explain">
                (*) <?php echo $this->lang->L_CONFIRM_PASSWORD_EXPLAIN;?>
            </div>
        </td>
    </tr>
    <tr class="row-even">
        <td>&nbsp;</td>
        <td><button type="submit" class="Formbutton"><?php echo $this->getIcon('save', '');?> <?php echo $this->lang->L_SAVE_PASSWORD; ?></button></td>
    </tr>
</table>

<?php
if (!empty($projectConfig['vcsActivated'])) {
    ?>
    <div class="spacer"></div>
    <h4><?php echo $this->lang->L_PERSONAL_CREDENTIALS_VCS;?>:</h4>
    <p><?php echo $this->lang->L_ENTER_VCS_EXPLAIN;?></p>
    <table class="bdr" summary="Credentials for VCS access.">
        <tr class="thead">
            <th colspan="2"><?php echo $this->lang->L_VCS_CREDENTIALS;?></th>
        </tr>
        <tr class="row-odd">
            <td><label for="vcsUser"><?php echo $this->lang->L_USERNAME;?>:</label></td>
            <td>
                <input type="text" class="text" name="vcsUser" id="vcsUser" value="<?php echo $this->vcsUser; ?>"/>
            </td>
        </tr>
        <tr class="row-even">
            <td><label for="vcsPass">
                <?php echo $this->lang->L_PASSWORD;?>:<br />
                    (* <?php echo $this->lang->L_CONFIRM_PASSWORD_EXPLAIN;?>)
                </label></td>
            <td><input type="password" class="text" name="vcsPass" id="vcsPass" autocomplete="off"/></td>
        </tr>
        <tr class="row-odd">
            <td><label for="vcsPass2">
                <?php echo $this->lang->L_CONFIRM_PASSWORD;?>:<br />
                </label>
            </td>
            <td><input type="password" class="text" name="vcsPass2" id="vcsPass2" autocomplete="off"/></td>
        </tr>
        <tr class="row-even">
            <td></td>
            <td>
                <button type="button" onclick="$('#confirmVCDeletion').dialog('open');" class="Formbutton">
                    <?php echo $this->getIcon('delete', ''); ?> <?php echo $this->lang->L_DELETE_CREDENTIALS;?>
                </button>
            </td>
        </tr>
    </table>
<?php } ?>
<div class="spacer"></div>
<p>
    <button type="submit" class="Formbutton"><?php echo $this->getIcon('save', '');?> <?php echo $this->lang->L_SAVE_SETTINGS;?></button>
</p>
</form>
<div class="spacer"></div>

<?php
$this->popUpMessage()->addMessage(
    'confirmVCDeletion',
    $this->lang->L_CONFIRM_DELETE_VCS_CREDENTIALS,
    $this->lang->L_ARE_YOU_SURE_TO_DELETE_PERSONAL_VCS_CREDENTIALS,
    array(
        'modal' => true,
        'height' => 180,
        'width' => 320,
        'dialogClass' => 'info',
        'autoOpen' => false,
        'buttons' => array(
            'Yes' => 'function() { window.location.href="' . $this->baseUrl() . '/settings/delete-credentials/"; $(this).dialog("close"); }',
            'No' => 'function() { $(this).dialog("close"); }',
        ),
    )
);
if (isset($this->saved)) {
    if ($this->saved !== false) {
        $this->popUpMessage()->addMessage(
            'settingsSaved',
            $this->lang->L_SUCCESS,
            $this->lang->L_YOUR_SETTINGS_HAVE_BEEN_SAVED_SUCCESSFULLY,
            array(
                'modal' => true,
                'height' => 160,
                'width' => 260,
                'dialogClass' => 'info',
            )
        );
    } else {
        $this->popUpMessage()->addMessage(
            'settingsNotSaved',
            $this->lang->L_ERROR,
            $this->lang->L_ERROR_SAVING_CHANGE . '.<br>' . $this->lang->L_TRY_AGAIN,
            array(
                'modal' => true,
                'height' => 160,
                'width' => 260,
                'dialogClass' => 'info',
            )
        );
    }
};
$this->jQuery()->onLoadCaptureStart(); ?>
$('.switchUserReferenceLanguage').click(function() {
    var languageId = this.id.replace(/img-/, '');
    $('#img-' + languageId).html(imgAjax);
    $.ajax({
        type: 'POST',
        url: '<?php echo $this->serverUrl() . $this->baseUrl();?>/ajax/switch-reference-language-status' ,
        dataType: 'json',
        async : true,
        cache: false,
        data:{
            'languageId': languageId
        },
        success:function(data) {
            $('#img-' + languageId).html(data.icon);
        },
        error:function(error) {
            $('#img-' + languageId).html(imgError);
        }
    });
});
$('.switchUserReferenceLanguageLabel').click(function() {
    var id = $(this).attr('for');
    $('#' + id).trigger('click');
});

<?php
$this->jQuery()->onLoadCaptureEnd();