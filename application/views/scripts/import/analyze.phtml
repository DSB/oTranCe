<h2>Analyzing data:</h2>
<p>
    Found <?php echo $this->numberFormat(sizeof($this->extractedData));?> language keys.
    <br />Start import by clicking the "Import to database" button.
    <br /><br />
    <button type="button" class="Formbutton" id="importButton">
    <?php echo $this->getIcon('save', 'Save to database');?> Import to database
    </button>
</p>

<table class="bdr more-padding" summary="Extracted key-value pairs">
<tr class="thead">
    <th>Action</th>
    <th class="right">#</th>
    <th>Key</th>
    <th>Value</th>
</tr>
<?php
$cycleHelper = $this->cycle(array('row-even', 'row-odd'));
$i=1;
foreach ($this->extractedData as $key => $val) { ?>
    <tr class="<?php echo $cycleHelper->next();?> small">
        <td class="importLineHeight">
            <span id="<?php echo $key;?>" class="import"></span>
        </td>
        <td class="right"><?php echo $this->numberFormat($i);?>.</td>
        <td><?php echo $this->out($key);?></td>
        <td><?php echo $this->out($val);?></td>
    </tr>
<?php
    $i++;
}
?>
</table>
<div id="importInfo">
    <span class="headline">Import status:</span>
    <table style="width:100%" class="small" summary="Import status">
        <tr>
            <td>Keys total:</td>
            <td class="right"><?php echo sizeof($this->extractedData)?></td>
        </tr>
        <tr>
            <td>Keys processed:</td>
            <td class="right"><span id="processed">0</span></td>
        </tr>
        <tr>
            <td>Keys to import:</td>
            <td class="right"><span id="toImport"><?php echo sizeof($this->extractedData)?></span></td>
        </tr>
        <tr>
            <td>Saved:</td>
            <td class="right"><span id="savedSuccessfully">0</span></td>
        </tr>
        <tr>
            <td>Skipped:</td>
            <td class="right"><span id="skipped">0</span></td>
        </tr>
        <tr>
            <td>Errors:</td>
            <td class="right"><span id="errors">0</span></td>
        </tr>
        <tr>
            <td>Done:</td>
            <td class="right"><span id="done">-</span></td>
        </tr>
    </table>
</div>
<?php
$this->jQuery()->onLoadCaptureStart();
?>
$('#importButton').click(function () {
    $('.import').each(function (index, domElement) {
        key = domElement.id;
        importValues.push(key);
    });
    $('#importButton').attr('disabled','disabled');
    doImport();
});
<?php   $this->jQuery()->onLoadCaptureEnd(); ?>
<script type="text/javascript">
//<![CDATA[
var importValues = new Array();
var imgLoader = '<?php echo $this->getIcon('ajax-loader','');?>';
var imgOk = '<?php echo $this->getIcon('Ok', 'Saved successfully', 16);?>';
var imgError = '<?php echo $this->getIcon('Attention', 'An error occured', 16);?>';
var imgNoEditRight = '<?php echo $this->getIcon('NotOk', 'You are not allowed to edit this language!', 16);?>';
var imgNoAddRight = '<?php echo $this->getIcon('NotOk', 'You are not allowed to add new keys!', 16);?>';
var imgSameContentAsFallbackLanguage = '<?php echo $this->getIcon('Attention', 'The content is the same as in the fallback language. Not imported!', 16);?>';
var keysToProcess = new Array();
var requestUrl = '<?php echo $this->baseUrl();?>/ajax/import.key/';

function doImport() {
    // get next keys
    keysToProcess = importValues.slice(0,15);
    // remove copied items from old array
    importValues.reverse();
    for (var i=0; i < keysToProcess.length;i++) {
        importValues.pop();
    }
    importValues.reverse();

    if (keysToProcess.length > 0) {
        // need to save some more keys -> show ajax loader
        $.each(keysToProcess, function () {
               $('#' + this).html(imgLoader);
            }
        );

        $.ajax({
            'type':'POST',
            'url':requestUrl,
            'data':{
                'languageId':<?php echo $this->language;?>,
                'fileTemplate':<?php echo $this->fileTemplate;?>,
                'keys': keysToProcess
            },
            'success':function(data) {
                try {
                    var result = $.parseJSON(data);
                    $.each(result, function () {
                        setState(this.key,this.result);
                    });
                    scrollToId(result[(result.length -1)].key);
                    calcDone();
                    doImport();
                } catch(error) {
                    showError(data);
                }
            },
            error:function(error) {
                showError(error);
            }
        });
    } else {
        // show finish popup
        $('#importDone').dialog("open");
    }
}

function showError(error) {
    $('#requestError').html(error);
    $('#requestError').dialog("open");
}

function setState(id, state) {
    var content = '';
    switch (state) {
        case 1:
            content = imgOk;
            increase('savedSuccessfully');
            break;
        case 2:
            content = imgNoEditRight;
            increase('errors');
            break;
        case 3:
            content = imgNoAddRight;
            increase('errors');
            break;
        case 4:
            content = imgSameContentAsFallbackLanguage;
            increase('skipped');
            break;
        default:
            content = imgError;
            increase('errors');
            break;
    }
    $('#' + id).html(content);
    decrease('toImport');
    increase('processed');
}

function calcDone()
{
    var done = $('#processed').html();
    var total = <?php echo sizeof($this->extractedData);?>;
    var percentage = done * 100 / total;
    $('#done').html(Math.round(percentage) + '%');
}
/* for our "lovely" IE which gets confused and doesn't show the content if there are more than 903 language keys */
setPageActive();
//]]>
</script>
<?php
$this->jQuery()->onLoadCaptureStart();
$this->popUpMessage()->addMessage(
    'importDone',
    'Finished',
    'Congratulations.<br />The importer has processed all entries.',
    array(
        'modal' => true,
        'height' => 140,
        'width' => 320,
        'dialogClass' => 'info',
        'autoOpen' => false,
        'buttons' => array(
                        'Entries' => 'function() {
                                    $(this).dialog("close");
                                    window.location.href="'. $this->serverUrl() . $this->baseUrl().'/entries/index";
                                }',
                        'Import another file' => 'function() {
                            $(this).dialog("close");
                            window.location.href="'. $this->serverUrl() . $this->baseUrl().'/import/index";
                        }'
                    )
    )
);

$this->popUpMessage()->addMessage(
    'requestError',
    'Fatal error!',
    'Oops - there was a fatal error with the ajax request!<br />Please retry.',
    array(
        'modal' => true,
        'height' => 450,
        'width' => 600,
        'dialogClass' => 'error',
        'autoOpen' => false,
        'buttons' => array(
                        'Retry' => 'function() {
                                    $(this).dialog("close");
                                    doImport();
                                }'
                    )
    )
);
$this->jQuery()->onLoadCaptureEnd();